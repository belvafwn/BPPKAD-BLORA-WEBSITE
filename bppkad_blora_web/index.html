<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPPKAD Blora - Realisasi APBD 2017-2024</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>BPPKAD Kabupaten Blora</h1>
                <p>Realisasi APBD 2017-2024</p>
            </div>
        </div>
    </header>

    <nav class="navbar">
        <div class="nav-content">
            <ul class="nav-links">
                <li><a href="index.html" class="active">Dashboard</a></li>
                <li><a href="pendapatan.html">Pendapatan</a></li>
                <li><a href="pembelanjaan.html">Pembelanjaan</a></li>
                <li><a href="pembiayaan.html">Pembiayaan</a></li>
                <li><a href="admin.html" class="admin-link">Admin</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-title">
                <h2>Dashboard Realisasi APBD</h2>
                <p>Ringkasan data realisasi APBD Kabupaten Blora tahun 2017-2024</p>
            </div>

            <div class="stats-cards">
                <div class="card">
                    <h3>Total Pendapatan</h3>
                    <div class="stat-value" id="totalPendapatan">-</div>
                </div>
                <div class="card">
                    <h3>Total Pembelanjaan</h3>
                    <div class="stat-value" id="totalPembelanjaan">-</div>
                </div>
                <div class="card">
                    <h3>Total Pembiayaan</h3>
                    <div class="stat-value" id="totalPembiayaan">-</div>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-container">
                    <h3>Ringkasan APBD per Kategori</h3>
                    <canvas id="summaryChart"></canvas>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-container">
                    <h3>Trend Realisasi APBD 2017-2024</h3>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2024 BPPKAD Kabupaten Blora. Hak Cipta Dilindungi.</p>
        </div>
    </footer>

    <script src="js/supabase.js"></script>
    <script src="js/script.js"></script>
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                const data = await getAllData();
                updateStatsCards(data);
                createSummaryChart(data);
                createTrendChart(data);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateStatsCards(data) {
            const pendapatan = data.filter(item => item.kategori === 'Pendapatan');
            const pembelanjaan = data.filter(item => item.kategori === 'Pembelanjaan');
            const pembiayaan = data.filter(item => item.kategori === 'Pembiayaan');

            const totalPendapatan = pendapatan.reduce((sum, item) => sum + (item.realisasi || 0), 0);
            const totalPembelanjaan = pembelanjaan.reduce((sum, item) => sum + (item.realisasi || 0), 0);
            const totalPembiayaan = pembiayaan.reduce((sum, item) => sum + (item.realisasi || 0), 0);

            document.getElementById('totalPendapatan').textContent = formatRupiah(totalPendapatan);
            document.getElementById('totalPembelanjaan').textContent = formatRupiah(totalPembelanjaan);
            document.getElementById('totalPembiayaan').textContent = formatRupiah(totalPembiayaan);
        }

        function createSummaryChart(data) {
            const ctx = document.getElementById('summaryChart').getContext('2d');
            
            const categories = ['Pendapatan', 'Pembelanjaan', 'Pembiayaan'];
            const chartData = categories.map(kategori => {
                const items = data.filter(item => item.kategori === kategori);
                return items.reduce((sum, item) => sum + (item.realisasi || 0), 0);
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Realisasi (Rupiah)',
                        data: chartData,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            const years = [2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024];
            const categories = ['Pendapatan', 'Pembelanjaan', 'Pembiayaan'];
            
            const datasets = categories.map((kategori, index) => {
                const colors = [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(75, 192, 192, 1)'
                ];
                
                const yearlyData = years.map(year => {
                    const items = data.filter(item => item.kategori === kategori && item.tahun === year);
                    return items.reduce((sum, item) => sum + (item.realisasi || 0), 0);
                });

                return {
                    label: kategori,
                    data: yearlyData,
                    borderColor: colors[index],
                    backgroundColor: colors[index].replace('1)', '0.1)'),
                    fill: false,
                    tension: 0.1
                };
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>