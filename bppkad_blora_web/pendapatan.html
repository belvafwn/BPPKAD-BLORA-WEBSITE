<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendapatan - BPPKAD Blora</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>BPPKAD Kabupaten Blora</h1>
                <p>Realisasi Pendapatan APBD 2017-2024</p>
            </div>
        </div>
    </header>

    <nav class="navbar">
        <div class="nav-content">
            <ul class="nav-links">
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="pendapatan.html" class="active">Pendapatan</a></li>
                <li><a href="pembelanjaan.html">Pembelanjaan</a></li>
                <li><a href="pembiayaan.html">Pembiayaan</a></li>
                <li><a href="admin.html" class="admin-link">Admin</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-title">
                <h2>Data Pendapatan APBD</h2>
                <p>Realisasi pendapatan daerah Kabupaten Blora tahun 2017-2024</p>
            </div>

            <!-- Summary Cards -->
            <div class="stats-cards">
                <div class="card">
                    <h3>Total Anggaran</h3>
                    <div class="stat-value" id="totalAnggaran">-</div>
                </div>
                <div class="card">
                    <h3>Total Realisasi</h3>
                    <div class="stat-value" id="totalRealisasi">-</div>
                </div>
                <div class="card">
                    <h3>Persentase Capaian</h3>
                    <div class="stat-value" id="persentaseCapaian">-</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="chart-section">
                <div class="chart-container">
                    <h3>Realisasi Pendapatan per Subkategori</h3>
                    <canvas id="pendapatanChart"></canvas>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-container">
                    <h3>Trend Pendapatan 2017-2024</h3>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Data Table -->
            <div class="chart-section">
                <h3>Detail Data Pendapatan</h3>
                <div id="dataTable">
                    <div class="text-center">
                        <span class="loading"></span> Memuat data...
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2024 BPPKAD Kabupaten Blora. Hak Cipta Dilindungi.</p>
        </div>
    </footer>

    <script src="js/supabase.js"></script>
    <script src="js/script.js"></script>
    <script>
        // Load pendapatan data
        document.addEventListener('DOMContentLoaded', function() {
            loadCategoryData();
        });

        async function loadCategoryData() {
            try {
                const data = await getDataByCategory('Pendapatan');
                
                // Update summary cards
                updateSummaryCards(data);
                
                // Create charts
                createCategoryChart(data);
                createTrendChart(data);
                
                // Create data table
                createDataTable('dataTable', data, 'Pendapatan');
                
            } catch (error) {
                console.error('Error loading pendapatan data:', error);
                showAlert('Gagal memuat data pendapatan: ' + error.message, 'error');
            }
        }

        function updateSummaryCards(data) {
            const totalAnggaran = data.reduce((sum, item) => sum + (parseFloat(item.anggaran) || 0), 0);
            const totalRealisasi = data.reduce((sum, item) => sum + (parseFloat(item.realisasi) || 0), 0);
            const persentase = totalAnggaran > 0 ? ((totalRealisasi / totalAnggaran) * 100).toFixed(2) : 0;
            
            document.getElementById('totalAnggaran').textContent = formatRupiah(totalAnggaran);
            document.getElementById('totalRealisasi').textContent = formatRupiah(totalRealisasi);
            document.getElementById('persentaseCapaian').textContent = persentase + '%';
        }

        function createCategoryChart(data) {
            const chartData = processDataForChart(data, 'Pendapatan');
            if (chartData) {
                createBarChart('pendapatanChart', chartData, {
                    title: 'Perbandingan Anggaran vs Realisasi Pendapatan'
                });
            }
        }

        function createTrendChart(data) {
            const chartData = processDataForTrendChart(data, 'Pendapatan');
            if (chartData) {
                createLineChart('trendChart', chartData, {
                    title: 'Trend Pendapatan dari Tahun ke Tahun'
                });
            }
        }
    </script>
</body>
</html>